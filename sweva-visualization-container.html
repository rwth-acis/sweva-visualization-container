<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->
<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="sweva-visualization-container-panel.html">
<!--
An element providing a solution to no problem in particular.

Example:

    <seed-element></seed-element>

Example:

    <seed-element>
      <h2>Hello seed-element</h2>
    </seed-element>

@demo demo/index.html
@hero hero.svg
-->

<script src="../yjs/y.js"></script>
<script src="../y-memory/y-memory.js"></script>
<script src="../y-map/y-map.js"></script>
<script src="../y-array/y-array.js"></script>
<script src="../y-text/y-text.js"></script>

<script src="y-websockets-client.js"></script>
<dom-module id="sweva-visualization-container">
    <template>

        <style>
            :host {
                display: flex;
                flex-direction: row;
                box-sizing: border-box;
                width: 100%;
                height: 100%;
                min-height: 300px;
                border: 1px solid #808080;
                position: relative;
                font-family: 'Roboto', 'Noto', sans-serif;
            }

            #visualization-area {
                flex: 1 1 0;
                background: #ffffff;
                overflow: overlay;
            }
        </style>
        <div id="visualization-area">
        </div>
        <sweva-visualization-container-panel id="panel"
                                             on-inputchanged="handleInputChanged"
                                             on-roomchanged="handleRoomChanged"
                                             on-executed="handleExecuted"
                                             room="{{room}}">

        </sweva-visualization-container-panel>
    </template>
    <script src="http://localhost:5001/core.build.js"></script>
    <script>
        Polymer({
            is: 'sweva-visualization-container',

            properties: {
                toolUrl: {
                    type: String,
                    value: null
                },
                controls: {
                    type: Array,
                    value: []
                },
                input: {
                    type: Object,
                    value: {}
                },
                result: {
                    type: Object,
                    value: {}
                },
                executionManager: {
                    type: Object,
                    value: null
                },
                yjs: {
                    type: Object,
                    value: null
                },
                composition: {
                    type: Object,
                    value: {}
                },
                room: {
                    type: String,
                    value: 'defaultSwevaVisRoom1'
                },
                visualizationUrlPrefix:{
                    type: String,
                    value: ' '
                },
                visualizationUrlSuffix:{
                    type: String,
                    value: ' '
                }
            },

            // Element Lifecycle

            ready: function () {
                this.executionManager = new sweva.ExecutionManager();
                var self = this;
                this.executionManager.onProgress(function (progress) {
                    var panel = self.$.panel;
                    panel.updateProgress(progress);
                });
            },

            attached: function () {
                this.init();
            },

            detached: function () {

            },

           
            // Element Behavior
            handleRoomChanged: function(event){
                this.room = event.detail;
              
                this.yjs.connector.options.room = this.room;
                this.yjs = null;
                console.log(this.room)
                this.init();
            },
            handleExecuted: function (event) {
                var self = this;
                this.input = event.detail;
                
                var panel = this.$.panel;
                panel.resetProgress();

               

                this.executionManager.execute(
                    {},
                    this.input
                    )
                    .then(function (result) {
                        self.result = result;
                        
                        self.updateVisualization();
                       

                    });
            },
            handleInputChanged: function (event) {
                var input = event.detail;
                this.input = input;
                
            },
            load: function (composition) {

                if(typeof composition === 'object'){
                    this.composition = composition;
                }

                this.executionManager.setup(this.composition);
                if (this.composition.controls) {
                    this.$.panel.sections = this.composition.controls;
                }
                else {
                    this.$.panel.sections = this.controls;
                }
                if (this.composition.visualization) {
                    this.toolUrl = this.composition.visualization;
                }

                this.loadVisualizationTool(this.toolUrl)
                .then(function () {
                    console.log('all loaded');
                })
            },
            updateVisualization: function(){
                var visualization = this.querySelector('#visualization-tool');
                visualization.set(this.result);
            },
            loadVisualizationTool: function (url) {
                var self = this;
                return new Promise(function (resolve, reject) {
                    if (typeof url === 'undefined' || url === null) {
                        reject();
                    }
                    var area = self.querySelector('#visualization-area');
                    var children = Polymer.dom(area).children;
                    for (var i = 0; i < children.length; i++) {
                        Polymer.dom(area).removeChild(children[i]);
                    }
                    Polymer.dom.flush();

                    if (url.indexOf('http') != 0) {
                        url = self.visualizationUrlPrefix + url + self.visualizationUrlSuffix;
                    }
                    self.importHref(url, function (e) {
                        // e.target.import is the import document.
                        var newElement = document.createElement('sweva-visualization-line-graph');
                        //newElement.myProperty = 'foo';
                        newElement.id = 'visualization-tool';



                        Polymer.dom(area).appendChild(newElement);
                       
                        Polymer.dom.flush();
                        resolve();
                    },
                    function (e) {
                        reject(e);
                    });
                })
            },
            init: function () {
                var self = this;
                Y({
                    db: {
                        name: 'memory'
                    },
                    connector: {
                        name: 'websockets-client',
                        room: self.room//'swevavisualtest1'
                        // debug: true,
                        // url: 'http://127.0.0.1:2345'
                    },
                    sourceDir: /*'../../bower_components/',//*/'http://127.0.0.1:8021/yjs/bower_components',
                    share: {
                       
                        chat: 'Array',
                        input: 'Map',
                        inputUpdates: 'Array'
                       
                    }
                }).then(function (y) {
                    self.yjs = y;
                   
                   
                    var panel = self.$.panel;

                    panel.init(y);

                    self.fire('initialized');
                });
            }

        });
    </script>
</dom-module>